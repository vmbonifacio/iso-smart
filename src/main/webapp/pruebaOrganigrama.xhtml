<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="/WEB-INF/template.xhtml">

    <ui:define name="head">
        <style>
            .organigram-wrapper {
                display: flex;
                flex-direction: row-reverse;
            }


            .organigram-wrapper .organigram-sidebar {
                width: 14%;
                background-color: #f2f2f2;
                padding: 0;
                box-sizing: border-box;
                color: black;
                display: flex;
                flex-direction: column;
                align-items: center;
                border-radius: 11px;
            }

            .organigram-wrapper .organigram-sidebar .sidebar-item {
                margin-bottom: 5px;
                margin-top: 5px;
                cursor: grabbing;
            }

            .organigram-wrapper .organigram-content {
                flex: 1;
                padding: 10px;
                box-sizing: border-box;
                position: relative;
                display: flex;
                flex-direction: column; /* Cambiar la dirección de los nodos a vertical */
                align-items: center; /* Centrar los nodos horizontalmente */
            }

            .ui-organigram-node {
                position: relative;
                padding: 10px;
                cursor: move;
                margin: 10px;
                width: 150px; /* Ancho fijo para los nodos */
                text-align: center; /* Centrar el texto horizontalmente */
            }

            .ui-organigram-node.added {
                background-color: inherit;
            }

            .gerencia-general-node {
                background-color: #FFCD29;
                width: 120px;
                border-radius: 10px;
            }

            .marketing-node {
                background-color: #9747FF;
                height: 60px;
                width: 120px;
                border-radius: 10px;
                padding-top: 17px;
            }

            .contabilidad-node {
                background-color: #14AE5C;
                height: 60px;
                width: 120px;
                border-radius: 10px;
                padding-top: 17px;
            }

            .administracion-node {
                background-color: #006EBE;
                height: 60px;
                width: 120px;
                border-radius: 10px;
                padding-top: 17px;
            }

            .connection {
                position: absolute;
                background-color: black;
                width: 2px;
                transform-origin: top center; /* Cambiar el origen de la transformación */
            }
            .titulo{
                background-color:#F8DA45;
                width: 100%;
                border-top-right-radius:11px;
                border-top-left-radius:11px;
                text-align: center;
                padding-top: 7px;
            }
        </style>
    </ui:define>

    <ui:define name="viewname">
        <li>FORMULARIO</li>
        <li><i class="pi pi-chevron-right"></i></li>
        <li>ORGANIGRAMA</li>
    </ui:define>

    <ui:define name="content">
        <div class="card">
            <div class="organigram-wrapper">
                <div class="organigram-sidebar">
                    <div class="titulo">
                        <h4>Formas</h4>
                    </div>
                    <div class="sidebar-item" draggable="true" ondragstart="dragStart(event);">
                        <div id="gerenciaGeneralNode" class="ui-organigram-node gerencia-general-node" draggable="true">
                            Gerencia General
                        </div>
                    </div>

                    <div class="sidebar-item" draggable="true" ondragstart="dragStart(event);">
                        <div id="administracionNode" class="ui-organigram-node administracion-node" draggable="true">
                            Administración
                        </div>
                    </div>

                    <div class="sidebar-item" draggable="true" ondragstart="dragStart(event);">
                        <div id="marketingNode" class="ui-organigram-node marketing-node" draggable="true">
                            Marketing
                        </div>
                    </div>

                    <div class="sidebar-item" draggable="true" ondragstart="dragStart(event);">
                        <div id="contabilidadNode" class="ui-organigram-node contabilidad-node" draggable="true">
                            Contabilidad
                        </div>
                    </div>
                </div>

                <div class="organigram-content" id="organigramContainer" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
                <svg id="connectionsContainer" class="connections-container"></svg>
            </div>
        </div>

        <script>
            let gerenciaGeneralAdded = false; // Variable de control para verificar si el nodo "Gerencia General" ha sido agregado

            function allowDrop(event) {
                event.preventDefault();
            }

            function dragStart(event) {
                event.dataTransfer.setData("text/plain", event.target.id);
                event.dataTransfer.effectAllowed = "move";
            }

            function drop(event) {
                event.preventDefault();
                const nodeId = event.dataTransfer.getData("text/plain");
                const draggedNode = document.getElementById(nodeId);

                const container = document.getElementById("organigramContainer");

                // Verificar si el nodo ya existe en el organigramContainer
                const existingNode = container.querySelector(".gerencia-general-node");

                // Evitar agregar el nodo "Gerencia General" si ya existe
                if (nodeId === "gerenciaGeneralNode") {
                    if (existingNode || gerenciaGeneralAdded) {
                        return;
                    }
                    gerenciaGeneralAdded = true; // Establecer la variable de control como verdadera
                }

                const newNode = draggedNode.cloneNode(true);
                newNode.classList.add("ui-organigram-node", "added");

                const offsetX = event.clientX - container.getBoundingClientRect().left - newNode.offsetWidth / 2;
                const offsetY = event.clientY - container.getBoundingClientRect().top - newNode.offsetHeight / 2;

                newNode.style.left = `${offsetX}px`;
                newNode.style.top = `${offsetY}px`;

                newNode.addEventListener("dragstart", dragStart);

                // Copiar los estilos del nodo original al nodo clonado
                const originalStyles = window.getComputedStyle(draggedNode);
                Array.from(originalStyles).forEach((property) => {
                    newNode.style[property] = originalStyles[property];
                });

                container.appendChild(newNode);

                // Conectar los nodos automáticamente si no son el mismo nodo
                const nodes = container.getElementsByClassName("ui-organigram-node");
                if (nodes.length > 1) {
                    const previousNode = nodes[nodes.length - 2];
                    const currentNode = newNode;
                    createConnection(previousNode, currentNode);
                }
            }
            //LINEA DE CONEXION
            function createConnection(startNode, endNode) {
                const container = document.getElementById("organigramContainer");

                const startX = startNode.offsetLeft + startNode.offsetWidth / 2;
                const startY = startNode.offsetTop + startNode.offsetHeight;
                const endX = endNode.offsetLeft + endNode.offsetWidth / 2;
                const endY = endNode.offsetTop;

                const connection = document.createElement("div");
                connection.classList.add("connection");
                connection.style.position = "absolute";
                connection.style.width = "2px";
                connection.style.height = Math.abs(endY - startY) + "px";
                connection.style.left = Math.min(startX, endX) + "px";
                connection.style.top = Math.min(startY, endY) + "px";
                connection.style.transform = `translate(-50%, 0)`; /* Ajustar la posición vertical de la línea */

                container.appendChild(connection);
            }
        </script>
    </ui:define>
</ui:composition>
